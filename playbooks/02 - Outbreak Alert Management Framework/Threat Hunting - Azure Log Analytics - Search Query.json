{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "Threat Hunting - Azure Log Analytics - Search Query",
    "aliasName": null,
    "tag": null,
    "description": "Retrieves data using a outbreak alert query from Azure Log Analytics and create FortiSOAR events",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "microsoft_sentinel_query",
        "time_span"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/2ae30943-7a2f-435b-a100-3ec7c3e2294b",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/7d254653-484f-42ca-8794-86bdf6f2300c",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "data": "{% set response = [] %}{% for row in vars.steps.Execute_Query.data.tables[0].rows %}{% set data_row = {} %}{% for v in row %}{% set k = vars.steps.Execute_Query.data.tables[0].columns[loop.index0].name %}{% set _ = data_row.update({k: v}) %}{% endfor %}{% set _ = response.append(data_row) %}{% endfor %}{{response}}"
            },
            "status": null,
            "top": "300",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "249742df-0e03-4b24-a512-1de88111e60c"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Event",
            "description": null,
            "arguments": {
                "for_each": {
                    "item": "{{vars.data}}",
                    "__bulk": true,
                    "parallel": false,
                    "condition": "",
                    "batch_size": 100
                },
                "resource": {
                    "name": "Outbreak Alert - {{vars.input.params['microsoft_sentinel_query'].title}}",
                    "source": "Azure Log Analytics",
                    "sourceId": "{{vars.item.MeterId}}",
                    "__replace": "",
                    "description": "{{vars.item | toJSON}}",
                    "outbreakAlerts": "{{vars.input.records[0]['@id']}}"
                },
                "operation": "Overwrite",
                "collection": "\/api\/3\/events",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "435",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "398fb577-4fab-4abc-8557-5b680b3d7451"
        },
        {
            "@type": "WorkflowStep",
            "name": "Execute Query",
            "description": null,
            "arguments": {
                "name": "Azure Log Analytics",
                "config": "bf8b0340-c5d3-4f7b-82d6-813a21ea5b50",
                "params": {
                    "query": "{{vars.input.params['microsoft_sentinel_query'].query}}",
                    "timespan": "PT{{(vars.input.params['time_span'] | string).replace('-', '')}}H",
                    "workspaces": "",
                    "WorkspaceId": "6c3970b0-0d7b-4e81-bb05-25e1c2cfdc2e"
                },
                "version": "2.0.0",
                "connector": "azure-log-analytics",
                "operation": "execute_query",
                "mock_result": "{\n  \"data\": {\n    \"tables\": [\n      {\n        \"name\": \"PrimaryResult\",\n        \"columns\": [\n          {\n            \"name\": \"TenantId\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"Computer\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"TimeGenerated\",\n            \"type\": \"datetime\"\n          },\n          {\n            \"name\": \"SourceSystem\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"StartTime\",\n            \"type\": \"datetime\"\n          },\n          {\n            \"name\": \"EndTime\",\n            \"type\": \"datetime\"\n          },\n          {\n            \"name\": \"ResourceUri\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"LinkedResourceUri\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"DataType\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"Solution\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"BatchesWithinSla\",\n            \"type\": \"long\"\n          },\n          {\n            \"name\": \"BatchesOutsideSla\",\n            \"type\": \"long\"\n          },\n          {\n            \"name\": \"BatchesCapped\",\n            \"type\": \"long\"\n          },\n          {\n            \"name\": \"TotalBatches\",\n            \"type\": \"long\"\n          },\n          {\n            \"name\": \"AvgLatencyInSeconds\",\n            \"type\": \"real\"\n          },\n          {\n            \"name\": \"Quantity\",\n            \"type\": \"real\"\n          },\n          {\n            \"name\": \"QuantityUnit\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"IsBillable\",\n            \"type\": \"bool\"\n          },\n          {\n            \"name\": \"MeterId\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"LinkedMeterId\",\n            \"type\": \"string\"\n          },\n          {\n            \"name\": \"Type\",\n            \"type\": \"string\"\n          }\n        ],\n        \"rows\": [\n          [\n            \"b438b4f6-912a-46d5-9cb1-b44069212abc\",\n            \"ContosoSQLSrv1\",\n            \"2017-08-24T06:59:59Z\",\n            \"OMS\",\n            \"2017-08-24T06:00:00Z\",\n            \"2017-08-24T06:59:59Z\",\n            \"\/subscriptions\/e4272367-5645-4c4e-9c67-3b74b59a6982\/resourcegroups\/contosoazurehq\/providers\/microsoft.operationalinsights\/workspaces\/contosoretail-it\",\n            null,\n            \"Perf\",\n            \"LogManagement\",\n            \"1\",\n            \"0\",\n            \"0\",\n            \"1\",\n            \"1.286\",\n            \"0.076408\",\n            \"MBytes\",\n            \"true\",\n            \"a4e29a95-5b4c-408b-80e3-113f9410566e\",\n            \"00000000-0000-0000-0000-000000000000\",\n            \"Usage\"\n          ],\n          [\n            \"b438b4f6-912a-46d5-9cb1-b44069212abc\",\n            \"Store010Web3\",\n            \"2017-08-24T06:59:59Z\",\n            \"OMS\",\n            \"2017-08-24T06:00:00Z\",\n            \"2017-08-24T06:59:59Z\",\n            \"\/subscriptions\/e4272367-5645-4c4e-9c67-3b74b59a6982\/resourcegroups\/contosoazurehq\/providers\/microsoft.operationalinsights\/workspaces\/contosoretail-it\",\n            null,\n            \"Perf\",\n            \"LogManagement\",\n            \"1\",\n            \"0\",\n            \"0\",\n            \"1\",\n            \"1.7\",\n            \"0.106767\",\n            \"MBytes\",\n            \"true\",\n            \"a4e29a95-5b4c-408b-80e3-113f9410566e\",\n            \"00000000-0000-0000-0000-000000000000\",\n            \"Usage\"\n          ]\n        ]\n      }\n    ]\n  },\n  \"status\": \"Success\",\n  \"message\": \"\",\n  \"operation\": null,\n  \"execution_time\": \"698 ms\"\n}",
                "operationTitle": "Execute Query",
                "pickFromTenant": false,
                "step_variables": []
            },
            "status": null,
            "top": "165",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "dc08a0e2-ae6c-4e10-bca9-e00c6be85f29"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    },
                    "useMockOutput": "{{globalVars.Demo_mode}}"
                }
            },
            "status": null,
            "top": "30",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "7d254653-484f-42ca-8794-86bdf6f2300c"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Create Event",
            "targetStep": "\/api\/3\/workflow_steps\/398fb577-4fab-4abc-8557-5b680b3d7451",
            "sourceStep": "\/api\/3\/workflow_steps\/249742df-0e03-4b24-a512-1de88111e60c",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "7a11e446-1ba7-474b-a9f5-54f85fb1551c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Execute Query -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/249742df-0e03-4b24-a512-1de88111e60c",
            "sourceStep": "\/api\/3\/workflow_steps\/dc08a0e2-ae6c-4e10-bca9-e00c6be85f29",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "2f854565-2afa-460f-8a95-6dcfeb42efb6"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Execute Query",
            "targetStep": "\/api\/3\/workflow_steps\/dc08a0e2-ae6c-4e10-bca9-e00c6be85f29",
            "sourceStep": "\/api\/3\/workflow_steps\/7d254653-484f-42ca-8794-86bdf6f2300c",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "e0366bac-f00e-4f81-8865-e2a9e2e55cd9"
        }
    ],
    "groups": [],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "21d97105-d3fd-4ea2-9f34-c4c33e60aff4",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Subroutine",
        "Outbreak Alert",
        "Azure Log Analytics"
    ]
}