{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "IOC Threat Hunt - Splunk",
    "aliasName": null,
    "tag": "#FortiSIEM",
    "description": "Performs Splunk IOC Hunting on the specified IOC.",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "ioc_type",
        "ioc_value",
        "last_pull_time_hrs",
        "splunk_head_limit",
        "splunk_search_query_sourcetype",
        "splunk_search_query_index"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/2ae30943-7a2f-435b-a100-3ec7c3e2294b",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/7bba009d-5f8f-45e1-9e1c-8a7e8e29c8e9",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Build Search Query",
            "description": null,
            "arguments": {
                "search_query": "index=\"{{vars.index}}\" sourcetype=\"{{vars.sourcetype}}\" ({% set ls_length =vars.indicator_mapping[vars.ioc_type] | length %}{% set ioc_length = vars.ioc_value | length %}{% for item in vars.indicator_mapping[vars.ioc_type] %}{% set outer_loop = loop %}{% for ioc in vars.ioc_value %}{% if loop.index < ioc_length %}{{item}}=\"{{ioc}}\" OR {% else %}{{item}}=\"{{ioc}}\"{% endif %}{% endfor %}{% if outer_loop.index < ls_length %} OR {% endif %}{% endfor %}) | head limit={{vars.head_limit}}"
            },
            "status": null,
            "top": "300",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "fbf9326e-4168-4291-bd42-0ea109bfd5b5"
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "index": "{{vars.input.params['splunk_search_query_index']}}",
                "ioc_type": "{{vars.input.params['ioc_type']}}",
                "ioc_value": "{{vars.input.params['ioc_value']}}",
                "head_limit": "{{vars.input.params['splunk_head_limit']}}",
                "sourcetype": "{{vars.input.params['splunk_search_query_sourcetype']}}",
                "earliest_time": "{{vars.input.params['last_pull_time_hrs']}}h",
                "useMockOutput": "{{globalVars.Demo_mode}}",
                "indicator_mapping": "{\n  \"FileHash\": [\n    \"file_hash\"\n  ],\n \"FileHash-MD5\": [\n    \"file_hash\",\n     \"md5\"\n  ],\n  \"FileHash-SHA1\": [\n    \"file_hash\",\n    \"sha1\"\n  ],\n  \"FileHash-SHA256\": [\n    \"file_hash\"\n    \"sha256\"\n  ],\n  \"Host\": [\n    \"host\",\n    \"domain\"\n  ],\n  \"Domain\": [\n    \"domain\",\n    \"host\"\n  ],\n  \"IP Address\": [\n    \"source_ip\",\n    \"destination_ip\"\n  ],\n  \"URL\": [\n    \"url\"\n  ],\n  \"Actor\":[\n    \"user\"\n  ],\n \"Process\": [\n   \"process_name\"\n ]\n}",
                "outbreak_alert_iri": "{{vars.input.records[0]['@id']}}",
                "outbreak_alert_name": "{{vars.input.records[0].title}}"
            },
            "status": null,
            "top": "160",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "a5dc3846-0ab5-4976-9363-8fd90911252b"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Events Alert",
            "description": null,
            "arguments": {
                "resource": {
                    "name": "Outbreak IOC Hunt - Splunk - {{(arrow.utcnow() | string).split('T')[0]}}",
                    "type": "\/api\/3\/picklists\/f2fb4c85-baae-407e-b218-1cc54a49546c",
                    "state": "\/api\/3\/picklists\/a1bac09b-1441-45aa-ad1b-c88744e48e72",
                    "__link": {
                        "recordTags": "{{vars.input.records[0].recordTags | join(\",\")}}"
                    },
                    "source": "Splunk",
                    "status": "\/api\/3\/picklists\/7de816ff-7140-4ee5-bd05-93ce22002146",
                    "severity": "\/api\/3\/picklists\/7efa2220-39bb-44e4-961f-ac368776e3b0",
                    "sourceId": "s{{vars.ioc_value | hash('md5')}}",
                    "__replace": "true",
                    "sourceType": "{{vars.outbreak_alert_name}}",
                    "sourcedata": "{{vars.steps.Hunt_IOC.data | toJSON}}",
                    "description": "The threat hunt activity was run for tracing following IOC's in ***Splunk*** as a part of ***Outbreak Alert - {{vars.outbreak_alert_name}}***\n{{vars.steps.Format_Splunk_IOC_Summary.data}}\n<br>\nFollowing events has been traced as part of above IOC hunt activity\n{{vars.steps.Format_Splunk_Hunt_Summary.data}}",
                    "ackSlaStatus": "\/api\/3\/picklists\/72979f64-e8b9-4888-a965-957e0ec24818",
                    "respSlaStatus": "\/api\/3\/picklists\/72979f64-e8b9-4888-a965-957e0ec24818",
                    "outbreakAlerts": "{{vars.outbreak_alert_iri}}",
                    "priorityWeight": 1,
                    "escalatedtoincident": "\/api\/3\/picklists\/2128a09c-153d-4db3-985d-de6be33deae5",
                    "resolvedAutomatedly": false,
                    "alertRemainingAckSLA": 0
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/alerts",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "975",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "848a29b0-dabf-4676-9a32-f9cbd675eb56"
        },
        {
            "@type": "WorkflowStep",
            "name": "Do Nothing",
            "description": null,
            "arguments": {
                "params": [],
                "version": "3.0.5",
                "connector": "cyops_utilities",
                "operation": "no_op",
                "operationTitle": "Utils: No Operation",
                "step_variables": []
            },
            "status": null,
            "top": "705",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "31f1ea05-66f4-4460-a4b4-f45745be8815"
        },
        {
            "@type": "WorkflowStep",
            "name": "Format Splunk Hunt Summary",
            "description": null,
            "arguments": {
                "params": {
                    "data": "{{vars.steps.Hunt_IOC.data.results}}",
                    "display": "Horizontal",
                    "styling": false,
                    "template": "Stylized with row selection",
                    "row_fields": ""
                },
                "version": "3.2.4",
                "connector": "cyops_utilities",
                "operation": "json_to_html",
                "operationTitle": "Utils: Convert JSON into a HTML Table",
                "step_variables": []
            },
            "status": null,
            "top": "705",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "f07bbef3-3d8a-4ac5-9c7c-dc582d20388b"
        },
        {
            "@type": "WorkflowStep",
            "name": "Format Splunk IOC Summary",
            "description": null,
            "arguments": {
                "params": {
                    "data": "[{\"{{vars.ioc_type}}\": \"<p style='word-break: break-word;white-space: pre-wrap;'>{{vars.ioc_value | join(' ,')}}<\/p>\"}]",
                    "display": "Vertical",
                    "styling": false,
                    "template": "Stylized with row selection",
                    "row_fields": ""
                },
                "version": "3.2.4",
                "connector": "cyops_utilities",
                "operation": "json_to_html",
                "operationTitle": "Utils: Convert JSON into a HTML Table",
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "dd538c54-b209-4e0a-b6b7-caa973650c76"
        },
        {
            "@type": "WorkflowStep",
            "name": "Found Splunk Search Results",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "Yes",
                        "step_iri": "\/api\/3\/workflow_steps\/f07bbef3-3d8a-4ac5-9c7c-dc582d20388b",
                        "condition": "{{ vars.steps.Hunt_IOC.data.results | length > 0 }}",
                        "step_name": "Format FortiAnalyzer Hunt Summary"
                    },
                    {
                        "option": "No",
                        "default": true,
                        "step_iri": "\/api\/3\/workflow_steps\/31f1ea05-66f4-4460-a4b4-f45745be8815",
                        "step_name": "Do Nothing"
                    }
                ],
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "18b7a05f-356a-4dcf-8b6b-3976b2d271e0"
        },
        {
            "@type": "WorkflowStep",
            "name": "Hunt IOC",
            "description": null,
            "arguments": {
                "name": "Splunk",
                "config": "7c495a0e-8f63-4218-a584-df2443e7c99e",
                "params": {
                    "app": "-",
                    "query": "{{vars.search_query}}",
                    "exec_mode": "One Shot",
                    "auto_cancel": "0",
                    "latest_time": "",
                    "earliest_time": "{{vars.earliest_time}}",
                    "additional_search_args": ""
                },
                "version": "1.6.3",
                "connector": "splunk",
                "operation": "invoke_search",
                "mock_result": "{\n  \"data\": {\n    \"fields\": [\n      {\n        \"name\": \"_bkt\"\n      },\n      {\n        \"name\": \"_cd\"\n      },\n      {\n        \"name\": \"_indextime\"\n      },\n      {\n        \"name\": \"_kv\"\n      },\n      {\n        \"name\": \"_raw\"\n      },\n      {\n        \"name\": \"_serial\"\n      },\n      {\n        \"name\": \"_si\"\n      },\n      {\n        \"name\": \"_sourcetype\"\n      },\n      {\n        \"name\": \"_subsecond\"\n      },\n      {\n        \"name\": \"_time\"\n      },\n      {\n        \"name\": \"host\"\n      },\n      {\n        \"name\": \"index\"\n      },\n      {\n        \"name\": \"linecount\"\n      },\n      {\n        \"name\": \"source\"\n      },\n      {\n        \"name\": \"sourcetype\"\n      },\n      {\n        \"name\": \"splunk_server\"\n      },\n      {\n        \"name\": \"url\"\n      }\n    ],\n    \"preview\": false,\n    \"results\": [\n      {\n        \"_cd\": \"72:4822328\",\n        \"_kv\": \"1\",\n        \"_si\": [\n          \"localhost.localdomain\",\n          \"_audit\"\n        ],\n        \"url\": \"http:\/\/clipper.guru\/bot\/regex\",\n        \"_bkt\": \"_audit~72~B0D09A60-ED18-43BB-904D-A8AEC8D88FBB\",\n        \"_raw\": \"Audit:[timestamp=09-12-2023 09:15:09.061, user=admin, action=search, info=granted , search_id='1694510109.6376', search='search index=\\\"_audit\\\" sourcetype=\\\"audittrail\\\" | search url=\\\"http:\/\/clipper.guru\/bot\/regex\\\"', autojoin='0', buckets=0, ttl=60, max_count=500000, maxtime=8640000, enable_lookups='1', extra_fields='', apiStartTime='Tue Sep 12 02:00:00 2023', apiEndTime='ZERO_TIME', apiIndexStartTime='ZERO_TIME', apiIndexEndTime='ZERO_TIME', savedsearch_name=\\\"\\\", is_proxied=false, app=\\\"search\\\", provenance=\\\"N\/A\\\", mode=\\\"historical\\\"]\",\n        \"host\": \"splunk.fortisoar.in\",\n        \"_time\": \"2023-09-12T09:15:09.061+00:00\",\n        \"index\": \"_audit\",\n        \"source\": \"audittrail\",\n        \"_serial\": \"0\",\n        \"linecount\": \"1\",\n        \"_indextime\": \"1694510109\",\n        \"_subsecond\": \".061217\",\n        \"sourcetype\": \"audittrail\",\n        \"_sourcetype\": \"audittrail\",\n        \"splunk_server\": \"localhost.localdomain\"\n      }\n    ],\n    \"messages\": [],\n    \"highlighted\": {},\n    \"init_offset\": 0\n  },\n  \"status\": \"Success\",\n  \"message\": \"\",\n  \"operation\": null,\n  \"execution_time\": \"1 seconds 477 ms\"\n}",
                "operationTitle": "Invoke Search",
                "pickFromTenant": false,
                "step_variables": []
            },
            "status": null,
            "top": "440",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "9db0f580-89a1-46ed-9bb1-17c3190914a2"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    }
                }
            },
            "status": null,
            "top": "30",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "7bba009d-5f8f-45e1-9e1c-8a7e8e29c8e9"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Build Search Query -> Hunt IOC",
            "targetStep": "\/api\/3\/workflow_steps\/9db0f580-89a1-46ed-9bb1-17c3190914a2",
            "sourceStep": "\/api\/3\/workflow_steps\/fbf9326e-4168-4291-bd42-0ea109bfd5b5",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "8a34f9d6-97e5-4aeb-8dce-51da7c8c8a30"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Config",
            "targetStep": "\/api\/3\/workflow_steps\/fbf9326e-4168-4291-bd42-0ea109bfd5b5",
            "sourceStep": "\/api\/3\/workflow_steps\/a5dc3846-0ab5-4976-9363-8fd90911252b",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "f99adb57-69a1-451d-b3ac-73338c1dd8e8"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Format QRadar IOC Summary -> Create Events Alert",
            "targetStep": "\/api\/3\/workflow_steps\/848a29b0-dabf-4676-9a32-f9cbd675eb56",
            "sourceStep": "\/api\/3\/workflow_steps\/dd538c54-b209-4e0a-b6b7-caa973650c76",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "481cc619-50cf-4f11-b4ba-18125a1f1c39"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Format Splunk Hunt Summary -> Format QRadar IOC Summary",
            "targetStep": "\/api\/3\/workflow_steps\/dd538c54-b209-4e0a-b6b7-caa973650c76",
            "sourceStep": "\/api\/3\/workflow_steps\/f07bbef3-3d8a-4ac5-9c7c-dc582d20388b",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "d9c8c65d-bc96-40aa-9328-2e86cbd58b7c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Found FortiSIEM Search Results -> Do Nothing",
            "targetStep": "\/api\/3\/workflow_steps\/31f1ea05-66f4-4460-a4b4-f45745be8815",
            "sourceStep": "\/api\/3\/workflow_steps\/18b7a05f-356a-4dcf-8b6b-3976b2d271e0",
            "label": "No",
            "isExecuted": false,
            "group": null,
            "uuid": "3c76ff3c-2cef-4c3b-82df-efe6f4596e27"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Found QRadar Search Results -> Format FortiSIEM Hunt Summary",
            "targetStep": "\/api\/3\/workflow_steps\/f07bbef3-3d8a-4ac5-9c7c-dc582d20388b",
            "sourceStep": "\/api\/3\/workflow_steps\/18b7a05f-356a-4dcf-8b6b-3976b2d271e0",
            "label": "Yes",
            "isExecuted": false,
            "group": null,
            "uuid": "b3d0b79b-58de-4690-9261-6fc2b9a0840e"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Hunt Query -> Found FortiSIEM Search Results",
            "targetStep": "\/api\/3\/workflow_steps\/18b7a05f-356a-4dcf-8b6b-3976b2d271e0",
            "sourceStep": "\/api\/3\/workflow_steps\/9db0f580-89a1-46ed-9bb1-17c3190914a2",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "a3eddff4-b021-45ba-af3b-11f62ceb61da"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/a5dc3846-0ab5-4976-9363-8fd90911252b",
            "sourceStep": "\/api\/3\/workflow_steps\/7bba009d-5f8f-45e1-9e1c-8a7e8e29c8e9",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "750d3c59-33a7-49fa-bdd4-48d8dfc47177"
        }
    ],
    "groups": [],
    "priority": null,
    "uuid": "a4b36f33-52db-49dd-85c5-fe4c9cc821df",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "PostCreate",
        "Outbreak Alert",
        "Splunk",
        "IOC Hunt"
    ]
}