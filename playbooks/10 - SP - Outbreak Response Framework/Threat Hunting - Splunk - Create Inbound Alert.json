{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "Threat Hunting - Splunk - Create Inbound Alert",
    "aliasName": null,
    "tag": null,
    "description": "Creates an alert in FortiSOAR with the event data",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "request_data",
        "title"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/2ae30943-7a2f-435b-a100-3ec7c3e2294b",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/5f6b19eb-3dbd-4515-bcfa-73e0737acacf",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Calculate Event ID",
            "description": null,
            "arguments": {
                "when": "{{'_time' in vars.sourcedata and '_raw' in vars.sourcedata and '_bkt' in vars.sourcedata}}",
                "config": "",
                "params": {
                    "python_function": "import hashlib\n\nevent= {{vars.sourcedata}}\nevent['_time'] =  {{vars.sourcedata['_time'] | int}}\n\ndef getUUID(_bkt):\n    return _bkt.split('~')[-1]\n\ndef generateHash(_time, _raw):\n    stringToHash = '{}{}'.format(_time, _raw).encode()\n    return hashlib.md5(stringToHash).hexdigest()\n\n\ndef createEventId(event):\n    try:\n        hashValue = generateHash(event['_time'], event['_raw'])\n        _bkt = event['_bkt']\n        uuid = getUUID(_bkt)\n        event_id = '{uuid}@@{index}@@{hash}'.format(uuid=uuid, index=event['index'], hash=hashValue)\n        event['event_id'] = event_id\n        print(event_id)\n    except Exception as e:\n        print('Failed generating event_id')    \n\n\ncreateEventId(event)"
                },
                "version": "2.0.0",
                "connector": "code-snippet",
                "operation": "python_inline",
                "operationTitle": "Execute Python Code",
                "step_variables": {
                    "_tmp": "{%set _dummy=vars.sourcedata.update({'event_id': vars.result.data['code_output']}) %}"
                }
            },
            "status": null,
            "top": "420",
            "left": "580",
            "stepType": "\/api\/3\/workflow_step_types\/1fdd14cc-d6b4-4335-a3af-ab49c8ed2fd8",
            "group": null,
            "uuid": "fb072c83-f9bf-49a5-8df4-4d00d18cf5cc"
        },
        {
            "@type": "WorkflowStep",
            "name": "Check Event ID Exists",
            "description": "",
            "arguments": {
                "conditions": [
                    {
                        "option": "Event ID Not Exists",
                        "step_iri": "\/api\/3\/workflow_steps\/fb072c83-f9bf-49a5-8df4-4d00d18cf5cc",
                        "condition": "{{ 'event_id' not in vars.sourcedata }}"
                    },
                    {
                        "option": "Event ID Exists",
                        "step_iri": "\/api\/3\/workflow_steps\/e70a213e-b4d9-4df2-a445-0a7eab7f9159",
                        "condition": "{{ true }}"
                    }
                ]
            },
            "status": null,
            "top": "300",
            "left": "218",
            "stepType": "\/api\/3\/workflow_step_types\/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "09918eba-1f91-465a-9804-73b511334661"
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "alerts_type_map": "{'USER_LOGIN': {{'AlertType'| picklist('Brute Force Attempts') }}, 'DNS Exfiltration': {{'AlertType'| picklist('Data Exfiltration') }} }",
                "alert_description": "<h2>Splunk data <\/h2><table  border ='1'> {%for key, value in vars.sourcedata.items()%} {%if value%}<tr> <td width='30%'>{{key}}<\/td> <td width='70%' >{{value |  replace('\"', '') }}<\/td>  <\/tr>  {%endif%}{%endfor%}  <\/table>",
                "alerts_status_map": "{'0': {{'AlertStatus'| picklist('Open') }}, '1': {{'AlertStatus'| picklist('Open') }}, '2': {{'AlertStatus'| picklist('Investigating') }}, '4': {{'AlertStatus'| picklist('Closed') }}, '5': {{'AlertStatus'| picklist('Closed') }}, '3': {{'AlertStatus'| picklist('Pending') }}}",
                "alerts_severity_map": "{'informational': {{'Severity'| picklist('Minimal') }}, 'low': {{'Severity'| picklist('Low') }}, 'medium': {{'Severity'| picklist('Medium') }}, 'high': {{'Severity'| picklist('High') }}, 'critical': {{'Severity'| picklist('Critical') }}}"
            },
            "status": null,
            "top": "165",
            "left": "218",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "6be7b4de-c301-419f-b9ab-6b9c20869f13"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Record",
            "description": null,
            "arguments": {
                "message": {
                    "tags": [
                        "\/api\/3\/tags\/Splunk"
                    ],
                    "type": "\/api\/3\/picklists\/ff599189-3eeb-4c86-acb0-a7915e85ac3b",
                    "tenant": "",
                    "thread": false,
                    "content": "<p>Created <strong><em>\"Outbreak Alert - {{vars.title}} - {{vars.sourcedata.search_name if vars.sourcedata.search_name else vars.sourcedata.rule_name if vars.sourcedata.rule_name else \"Event from Splunk\"}}\"<\/em> in <\/strong>Alert module for Splunk<em>&nbsp;<strong>events<\/strong>.<\/em><\/p>",
                    "records": "{{vars.input.records[0]['@id']}}"
                },
                "resource": {
                    "name": "Outbreak Alert - {{vars.title}} - {{vars.sourcedata.search_name if vars.sourcedata.search_name else vars.sourcedata.rule_name if vars.sourcedata.rule_name else \"Event from Splunk\"}}",
                    "type": "\/api\/3\/picklists\/f2fb4c85-baae-407e-b218-1cc54a49546c",
                    "state": "\/api\/3\/picklists\/a1bac09b-1441-45aa-ad1b-c88744e48e72",
                    "source": "Splunk",
                    "status": "{{vars.alerts_status_map[vars.sourcedata.status] if vars.sourcedata.status in vars.alerts_status_map else None}}",
                    "severity": "{{vars.alerts_severity_map[vars.sourcedata.urgency] if vars.sourcedata.urgency in vars.alerts_severity_map else None}}",
                    "sourceId": "{{vars.sourcedata.event_id | default(None)}}",
                    "__replace": "false",
                    "recordTags": "{{vars.input.records[0].recordTags | join(\",\")}}",
                    "sourcedata": "{{vars.sourcedata| toJSON}}",
                    "description": "<p>{{vars.alert_description}}<\/p>",
                    "targetAsset": "{{vars.sourcedata.host}}",
                    "ackSlaStatus": "\/api\/3\/picklists\/72979f64-e8b9-4888-a965-957e0ec24818",
                    "respSlaStatus": "\/api\/3\/picklists\/72979f64-e8b9-4888-a965-957e0ec24818",
                    "outbreakAlerts": "{{vars.input.records[0]['@id']}}",
                    "priorityWeight": 1,
                    "escalatedtoincident": "\/api\/3\/picklists\/2128a09c-153d-4db3-985d-de6be33deae5",
                    "resolvedAutomatedly": false,
                    "alertRemainingAckSLA": 0
                },
                "_showJson": false,
                "is_upsert": true,
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/alerts",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Overwrite"
                },
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "218",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "e70a213e-b4d9-4df2-a445-0a7eab7f9159"
        },
        {
            "@type": "WorkflowStep",
            "name": "Return Record",
            "description": null,
            "arguments": {
                "query": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": [
                        {
                            "type": "primitive",
                            "field": "sourceId",
                            "value": "{{ vars.sourcedata.event_id }}",
                            "operator": "eq"
                        }
                    ]
                },
                "module": "alerts?$limit=30",
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "218",
            "stepType": "\/api\/3\/workflow_step_types\/b593663d-7d13-40ce-a3a3-96dece928770",
            "group": null,
            "uuid": "76a813c1-48b3-4b88-8769-8fed32af86fc"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    },
                    "sourcedata": "{%if 'data' in vars.request %}{%set _dummy = vars.request.data.update({'uri': vars.request.uri})%}{%if 'result' in vars.request.data %}{%for k,v in vars.request.data.result.items()%}{%set _dummy= vars.request.data.update({k:v})%}{%endfor%}\n{%set _dummy= vars.request.data.pop('result') %}{%endif%}\n{{vars.request.data}}{%else%}{%set _dummy = vars.request_data.update( { \"route\": vars.route})%}{{vars.request_data}}{%endif%}"
                }
            },
            "status": null,
            "top": "30",
            "left": "218",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "5f6b19eb-3dbd-4515-bcfa-73e0737acacf"
        },
        {
            "@type": "WorkflowStep",
            "name": "Update Notable Fields",
            "description": null,
            "arguments": {
                "when": "{{'urgency' not in vars.sourcedata and 'owner' not in vars.sourcedata and 'event_id' in vars.sourcedata and 'notable' in vars.sourcedata.event_id}}",
                "arguments": {
                    "event_data": "{{vars.sourcedata}}"
                },
                "apply_async": false,
                "step_variables": [],
                "pass_parent_env": false,
                "pass_input_record": false,
                "workflowReference": "\/api\/3\/workflows\/948a53b6-ca7d-4bf6-98be-28a72654b0ee"
            },
            "status": null,
            "top": "705",
            "left": "218",
            "stepType": "\/api\/3\/workflow_step_types\/74932bdc-b8b6-4d24-88c4-1a4dfbc524f3",
            "group": null,
            "uuid": "218e74c2-43c9-4d9f-bfe0-676234cf9567"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Calculate Event ID -> Create Record",
            "targetStep": "\/api\/3\/workflow_steps\/e70a213e-b4d9-4df2-a445-0a7eab7f9159",
            "sourceStep": "\/api\/3\/workflow_steps\/fb072c83-f9bf-49a5-8df4-4d00d18cf5cc",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "6145d28f-e3c4-4eaa-b2a2-a31c27cf5d25"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Check Event ID Exists -> Calculate Event ID",
            "targetStep": "\/api\/3\/workflow_steps\/fb072c83-f9bf-49a5-8df4-4d00d18cf5cc",
            "sourceStep": "\/api\/3\/workflow_steps\/09918eba-1f91-465a-9804-73b511334661",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "9d56f8f0-e2ff-49bb-b664-2d50570428c7"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Check Event ID Exists -> Create Record",
            "targetStep": "\/api\/3\/workflow_steps\/e70a213e-b4d9-4df2-a445-0a7eab7f9159",
            "sourceStep": "\/api\/3\/workflow_steps\/09918eba-1f91-465a-9804-73b511334661",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "ce18598e-3491-4403-b4c6-5ab7d85850d8"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Check Event ID Exists",
            "targetStep": "\/api\/3\/workflow_steps\/09918eba-1f91-465a-9804-73b511334661",
            "sourceStep": "\/api\/3\/workflow_steps\/6be7b4de-c301-419f-b9ab-6b9c20869f13",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "8dd28419-76ab-4a56-9597-c6e4b2c4e0eb"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Create Record -> Update Notable Fields",
            "targetStep": "\/api\/3\/workflow_steps\/218e74c2-43c9-4d9f-bfe0-676234cf9567",
            "sourceStep": "\/api\/3\/workflow_steps\/e70a213e-b4d9-4df2-a445-0a7eab7f9159",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "64b8e231-aa05-46e2-aca8-3dc51faf79b7"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/6be7b4de-c301-419f-b9ab-6b9c20869f13",
            "sourceStep": "\/api\/3\/workflow_steps\/5f6b19eb-3dbd-4515-bcfa-73e0737acacf",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "f1d07406-4819-4ebf-9a18-27d4c9c1c78e"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Update Notable Fields -> Return Record",
            "targetStep": "\/api\/3\/workflow_steps\/76a813c1-48b3-4b88-8769-8fed32af86fc",
            "sourceStep": "\/api\/3\/workflow_steps\/218e74c2-43c9-4d9f-bfe0-676234cf9567",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "b8c4ecf6-d49a-4a1d-9b19-a1cb6a4568f4"
        }
    ],
    "groups": [],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "3a4f16a4-14bb-449a-9805-32396aea115b",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "Subroutine",
        "Outbreak Alert",
        "Splunk"
    ]
}