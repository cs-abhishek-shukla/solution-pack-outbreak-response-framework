{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "IOC Threat Hunt - QRadar",
    "aliasName": null,
    "tag": null,
    "description": "Performs QRadar IOC Hunting on the specified IOC.",
    "isActive": true,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [
        "ioc_type",
        "ioc_value",
        "qradar_max_events",
        "last_pull_time_hrs"
    ],
    "synchronous": false,
    "collection": "\/api\/3\/workflow_collections\/2ae30943-7a2f-435b-a100-3ec7c3e2294b",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/f54b9dbf-8a09-4764-aadc-ff8e04d98468",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Build Search Query",
            "description": null,
            "arguments": {
                "search_query": "{% if vars.ioc_type in [\"IP Address\", \"Actor\"] %}SELECT * from events WHERE ({% set ls_length =vars.indicator_mapping[vars.ioc_type] | length %}{% set ioc_length = vars.ioc_value | length %}{% for item in vars.indicator_mapping[vars.ioc_type] %}{% set outer_loop = loop %}{% for ioc in vars.ioc_value %}{% if loop.index < ioc_length %}{{item}}='{{ioc}}' OR {% else %}{{item}}='{{ioc}}'{% endif %}{% endfor %}{% if outer_loop.index < ls_length %} OR {% endif %}{% endfor %}) LIMIT {{vars.max_event}} LAST {{vars.last_hrs}} HOURS{% else %}SELECT * from events WHERE ({% set ls_length =vars.indicator_mapping[vars.ioc_type] | length %}{% set ioc_length = vars.ioc_value | length %}{% for item in vars.indicator_mapping[vars.ioc_type] %}{% set outer_loop = loop %}{% for ioc in vars.ioc_value %}{% if loop.index < ioc_length %}\"{{item}}\"='{{ioc}}' OR {% else %}\"{{item}}\"='{{ioc}}'{% endif %}{% endfor %}{% if outer_loop.index < ls_length %} OR {% endif %}{% endfor %}) LIMIT {{vars.max_event}} LAST {{vars.last_hrs}} HOURS{% endif %}"
            },
            "status": null,
            "top": "300",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "6c975b5a-bad8-42e7-a870-21a980cec60e"
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "ioc_type": "{{vars.input.params['ioc_type']}}",
                "last_hrs": "{{(vars.input.params['last_pull_time_hrs'] | string).split('-')[-1]}}",
                "ioc_value": "{{vars.input.params['ioc_value']}}",
                "max_event": "{{vars.input.params['qradar_max_events']}}",
                "useMockOutput": "{{globalVars.Demo_mode}}",
                "indicator_mapping": "{\n  \"FileHash\": [\n    \"File Hash\"\n  ],\n \"FileHash-MD5\": [\n    \"MD5 Hash\",\n    \"File Hash\"\n  ],\n  \"FileHash-SHA1\": [\n    \"SHA1 Hash\",\n    \"File Hash\"\n  ],\n  \"FileHash-SHA256\": [\n    \"SHA256 Hash\",\n    \"File Hash\"\n  ],\n  \"Host\": [\n    \"Hostname\",\n    \"Source Host Name\",\n    \"User Domain\",\n    \"Destination Host Name\"\n  ],\n  \"Domain\": [\n    \"Hostname\",\n    \"Source Host Name\",\n    \"User Domain\",\n    \"Destination Host Name\"\n  ],\n  \"IP Address\": [\n    \"sourceip\",\n    \"destinationip\"\n  ],\n  \"URL\": [\n    \"URL\",\n    \"URL Path\",\n    \"UrlHost\"\n  ],\n \"Process\": [\n    \"Source Process\",\n    \"Process Name\"\n  ],\n \"Actor\": [\n   \"username\"\n ]\n}",
                "outbreak_alert_iri": "{{vars.input.records[0]['@id']}}",
                "outbreak_alert_name": "{{vars.input.records[0].title}}",
                "foundQRadarSearchResult": "false"
            },
            "status": null,
            "top": "160",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "group": null,
            "uuid": "93c2a6ed-ae2c-4ab4-ae5f-66ae86b88259"
        },
        {
            "@type": "WorkflowStep",
            "name": "Create Events Alert",
            "description": null,
            "arguments": {
                "resource": {
                    "name": "Outbreak IOC Hunt - QRadar - {{(arrow.utcnow() | string).split('T')[0]}}",
                    "type": "\/api\/3\/picklists\/f2fb4c85-baae-407e-b218-1cc54a49546c",
                    "state": "\/api\/3\/picklists\/a1bac09b-1441-45aa-ad1b-c88744e48e72",
                    "__link": {
                        "recordTags": "{{vars.input.records[0].recordTags | join(\",\")}}"
                    },
                    "source": "QRadar",
                    "status": "\/api\/3\/picklists\/7de816ff-7140-4ee5-bd05-93ce22002146",
                    "severity": "\/api\/3\/picklists\/7efa2220-39bb-44e4-961f-ac368776e3b0",
                    "sourceId": "q{{vars.ioc_value | hash('md5')}}",
                    "__replace": "true",
                    "sourceType": "{{vars.outbreak_alert_name}}",
                    "sourcedata": "{{vars.steps.Hunt_IOC.data | toJSON}}",
                    "description": "The threat hunt activity was run for tracing following IOC's in ***QRadar*** as a part of ***Outbreak Alert - {{vars.outbreak_alert_name}}***\n{{vars.steps.Format_QRadar_IOC_Summary.data}}\n<br>\nFollowing events has been traced as part of above IOC hunt activity\n{{vars.steps.Format_QRadar_Hunt_Summary.data}}",
                    "ackSlaStatus": "\/api\/3\/picklists\/72979f64-e8b9-4888-a965-957e0ec24818",
                    "respSlaStatus": "\/api\/3\/picklists\/72979f64-e8b9-4888-a965-957e0ec24818",
                    "outbreakAlerts": "{{vars.outbreak_alert_iri}}",
                    "priorityWeight": 1,
                    "escalatedtoincident": "\/api\/3\/picklists\/2128a09c-153d-4db3-985d-de6be33deae5",
                    "resolvedAutomatedly": false,
                    "alertRemainingAckSLA": 0
                },
                "_showJson": false,
                "operation": "Overwrite",
                "collection": "\/api\/3\/upsert\/alerts",
                "__recommend": [],
                "fieldOperation": {
                    "recordTags": "Append"
                },
                "step_variables": []
            },
            "status": null,
            "top": "975",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/2597053c-e718-44b4-8394-4d40fe26d357",
            "group": null,
            "uuid": "c820cbdc-b287-4190-b8c8-bd10bc175160"
        },
        {
            "@type": "WorkflowStep",
            "name": "Do Nothing",
            "description": null,
            "arguments": {
                "params": [],
                "version": "3.0.5",
                "connector": "cyops_utilities",
                "operation": "no_op",
                "operationTitle": "Utils: No Operation",
                "step_variables": []
            },
            "status": null,
            "top": "705",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "7fd3a198-2b28-4bb9-b6fd-ab9a2c4d5fb5"
        },
        {
            "@type": "WorkflowStep",
            "name": "Format QRadar Hunt Summary",
            "description": null,
            "arguments": {
                "params": {
                    "data": "{{vars.steps.Hunt_IOC.data.events}}",
                    "display": "Horizontal",
                    "styling": false,
                    "template": "Stylized with row selection",
                    "row_fields": ""
                },
                "version": "3.2.4",
                "connector": "cyops_utilities",
                "operation": "json_to_html",
                "operationTitle": "Utils: Convert JSON into a HTML Table",
                "step_variables": []
            },
            "status": null,
            "top": "705",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "48b2cc0b-89a1-4b7a-bc4a-8d4fc17ffcd4"
        },
        {
            "@type": "WorkflowStep",
            "name": "Format QRadar IOC Summary",
            "description": null,
            "arguments": {
                "params": {
                    "data": "[{\"{{vars.ioc_type}}\": \"<p style='word-break: break-word;white-space: pre-wrap;'>{{vars.ioc_value | join(' ,')}}<\/p>\"}]",
                    "display": "Vertical",
                    "styling": false,
                    "template": "Stylized with row selection",
                    "row_fields": ""
                },
                "version": "3.2.4",
                "connector": "cyops_utilities",
                "operation": "json_to_html",
                "operationTitle": "Utils: Convert JSON into a HTML Table",
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "475",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "group": null,
            "uuid": "1754c45b-3a54-4083-84bd-263a41a36a19"
        },
        {
            "@type": "WorkflowStep",
            "name": "Found QRadar Search Results",
            "description": null,
            "arguments": {
                "conditions": [
                    {
                        "option": "Yes",
                        "step_iri": "\/api\/3\/workflow_steps\/48b2cc0b-89a1-4b7a-bc4a-8d4fc17ffcd4",
                        "condition": "{{ vars.foundQRadarSearchResult }}",
                        "step_name": "Format QRadar Hunt Summary"
                    },
                    {
                        "option": "No",
                        "default": true,
                        "step_iri": "\/api\/3\/workflow_steps\/7fd3a198-2b28-4bb9-b6fd-ab9a2c4d5fb5",
                        "step_name": "Do Nothing"
                    }
                ],
                "step_variables": []
            },
            "status": null,
            "top": "570",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/12254cf5-5db7-4b1a-8cb1-3af081924b28",
            "group": null,
            "uuid": "949400d1-46be-4326-aa5b-da62d1c783ac"
        },
        {
            "@type": "WorkflowStep",
            "name": "Hunt IOC",
            "description": null,
            "arguments": {
                "name": "IBM QRadar",
                "config": "QRadar",
                "params": {
                    "search_string": "{{vars.search_query}}"
                },
                "version": "1.6.1",
                "connector": "qradar",
                "operation": "query_qradar",
                "mock_result": "{\n  \"data\": {\n    \"events\": [\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412667564,\n        \"eventcount\": 38,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 63415,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.34\",\n        \"destinationport\": 443\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412697545,\n        \"eventcount\": 40,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 63451,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.34\",\n        \"destinationport\": 443\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412487402,\n        \"eventcount\": 1,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 5353,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.159\",\n        \"destinationport\": 5353\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"224.0.0.251\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412487402,\n        \"eventcount\": 1,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 5353,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.159\",\n        \"destinationport\": 5353\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412487402,\n        \"eventcount\": 1,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 5353,\n        \"logsourceid\": 116,\n        \"destinationip\": \"224.0.0.251\",\n        \"destinationport\": 5353\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412487402,\n        \"eventcount\": 41,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 63169,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.34\",\n        \"destinationport\": 443\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412517373,\n        \"eventcount\": 38,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 63209,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.34\",\n        \"destinationport\": 443\n      },\n      {\n        \"qid\": 5002343,\n        \"category\": 18081,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\NETWORK\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412517374,\n        \"eventcount\": 1,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 0,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.159\",\n        \"destinationport\": 0\n      },\n      {\n        \"qid\": 5001840,\n        \"category\": 4012,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": \"NT AUTHORITY\\\\SYSTEM\",\n        \"magnitude\": 2,\n        \"starttime\": 1694412547438,\n        \"eventcount\": 41,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 63252,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.34\",\n        \"destinationport\": 443\n      },\n      {\n        \"qid\": 5002203,\n        \"category\": 8018,\n        \"sourceip\": \"10.132.253.159\",\n        \"username\": null,\n        \"magnitude\": 2,\n        \"starttime\": 1694412580481,\n        \"eventcount\": 1,\n        \"identityip\": \"0.0.0.0\",\n        \"protocolid\": 255,\n        \"sourceport\": 0,\n        \"logsourceid\": 116,\n        \"destinationip\": \"10.132.253.159\",\n        \"destinationport\": 0\n      }\n    ]\n  },\n  \"status\": \"Success\",\n  \"message\": \"\",\n  \"operation\": null,\n  \"execution_time\": \"10 seconds 353 ms\"\n}",
                "ignore_errors": true,
                "operationTitle": "Make an Ariel Query to QRadar",
                "pickFromTenant": false,
                "step_variables": {
                    "foundQRadarSearchResult": "{{ (vars.result.data.events | length > 0) | ternary(true,false) }}"
                }
            },
            "status": null,
            "top": "440",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/0bfed618-0316-11e7-93ae-92361f002671",
            "group": null,
            "uuid": "ce6dfcff-3b78-427e-96bc-428ad44f081e"
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "step_variables": {
                    "input": {
                        "params": []
                    }
                }
            },
            "status": null,
            "top": "30",
            "left": "300",
            "stepType": "\/api\/3\/workflow_step_types\/b348f017-9a94-471f-87f8-ce88b6a7ad62",
            "group": null,
            "uuid": "f54b9dbf-8a09-4764-aadc-ff8e04d98468"
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Build Search Query -> QRadar Full Search",
            "targetStep": "\/api\/3\/workflow_steps\/ce6dfcff-3b78-427e-96bc-428ad44f081e",
            "sourceStep": "\/api\/3\/workflow_steps\/6c975b5a-bad8-42e7-a870-21a980cec60e",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "60baf3ea-077c-40dc-8354-bc9fc8d4b38a"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Configuration -> Build Search Query",
            "targetStep": "\/api\/3\/workflow_steps\/6c975b5a-bad8-42e7-a870-21a980cec60e",
            "sourceStep": "\/api\/3\/workflow_steps\/93c2a6ed-ae2c-4ab4-ae5f-66ae86b88259",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "570eda3e-cea8-4cd3-b3a2-d8b48cc35ea1"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Format FortiAnalyzer IOC Summary -> Create Events Alert",
            "targetStep": "\/api\/3\/workflow_steps\/c820cbdc-b287-4190-b8c8-bd10bc175160",
            "sourceStep": "\/api\/3\/workflow_steps\/1754c45b-3a54-4083-84bd-263a41a36a19",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "f7036148-cfe6-45e7-8d70-18e8be000250"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Format QRadar Hunt Summary -> Format FortiAnalyzer IOC Summary",
            "targetStep": "\/api\/3\/workflow_steps\/1754c45b-3a54-4083-84bd-263a41a36a19",
            "sourceStep": "\/api\/3\/workflow_steps\/48b2cc0b-89a1-4b7a-bc4a-8d4fc17ffcd4",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "4d944d67-5ccd-44d2-9a9f-7d38f47a6a90"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Found QRadar Search Results -> Do Nothing",
            "targetStep": "\/api\/3\/workflow_steps\/7fd3a198-2b28-4bb9-b6fd-ab9a2c4d5fb5",
            "sourceStep": "\/api\/3\/workflow_steps\/949400d1-46be-4326-aa5b-da62d1c783ac",
            "label": "No",
            "isExecuted": false,
            "group": null,
            "uuid": "079d6aa7-f941-4fd2-9193-5abc353177f5"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Found QRadar Search Results -> Format QRadar Hunt Summary",
            "targetStep": "\/api\/3\/workflow_steps\/48b2cc0b-89a1-4b7a-bc4a-8d4fc17ffcd4",
            "sourceStep": "\/api\/3\/workflow_steps\/949400d1-46be-4326-aa5b-da62d1c783ac",
            "label": "Yes",
            "isExecuted": false,
            "group": null,
            "uuid": "c01eff58-1eb7-49a9-bb48-70afeba20c73"
        },
        {
            "@type": "WorkflowRoute",
            "name": "QRadar Full Search -> Found QRadar Search Results",
            "targetStep": "\/api\/3\/workflow_steps\/949400d1-46be-4326-aa5b-da62d1c783ac",
            "sourceStep": "\/api\/3\/workflow_steps\/ce6dfcff-3b78-427e-96bc-428ad44f081e",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "364ba26c-0fea-41f4-b32d-3542f547494c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Configuration",
            "targetStep": "\/api\/3\/workflow_steps\/93c2a6ed-ae2c-4ab4-ae5f-66ae86b88259",
            "sourceStep": "\/api\/3\/workflow_steps\/f54b9dbf-8a09-4764-aadc-ff8e04d98468",
            "label": null,
            "isExecuted": false,
            "group": null,
            "uuid": "12da0fb1-7e80-4cc4-87cd-dff1b213faec"
        }
    ],
    "groups": [],
    "priority": "\/api\/3\/picklists\/2b563c61-ae2c-41c0-a85a-c9709585e3f2",
    "uuid": "c2e66702-cb56-4180-9c0f-b00cd8a095e0",
    "owners": [],
    "isPrivate": false,
    "deletedAt": null,
    "recordTags": [
        "PostCreate",
        "Outbreak Alert",
        "QRadar",
        "IOC Hunt"
    ]
}